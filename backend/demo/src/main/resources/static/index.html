<!DOCTYPE html>
<html lang="en" xmlns="http://www.w3.org/1999/xhtml">

<head>
    <link rel="stylesheet" href="mystile.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/phaser/3.86.0/phaser.min.js"></script>
    <script src="https://code.jquery.com/jquery-2.2.0.min.js"></script>
    <script type="module" src="js/game.js"></script>
    <script src="js/intro.js"></script>
    <script src="js/end.js"></script>
    <script src="js/controls.js"></script>
    <script src="js/preview.js"></script>
    <script src="js/dialogo.js"></script>
    <script src="js/credit.js"></script>
    <script src="js/pause.js"></script>
    <script type="module" src="js/tutorial.js"></script>
    <script type="module" src="js/controlesJug.js"></script>
    <script type="module" src="js/ChatManager.js"></script>
    <script src="js/derrota.js"></script>
    <script src="js/Login.js"></script>

    <meta charset="utf-8" />
    <title>Mystery Mice</title>
</head>

<body>
    <div class="rectangulo"></div>
    
    <h1>Mystery Mice</h1>
      
    <div id="game-canvas" style="position: relative"></div>
    <div id="chat-container">
        <div id="users-count">Usuarios conectados: 0</div>
        <div id="chat-messages"></div>
        <input type="text" id="chat-input" placeholder="Escribe aquí tu mensaje" />
        <button id="chat-send">Enviar</button>
    </div>

    <div id="connection-status"></div>
    
    <script type="module">
        // Configuración del juego
        import GameScene from './js/game.js';
        import TutorialScene from './js/tutorial.js';
        import ChatManager from './js/ChatManager.js'; // Importa ChatManager para que esté disponible si es necesario

        var config = {
            type: Phaser.AUTO,
            scale: {
                mode: Phaser.Scale.FIT,
                autoCenter: Phaser.Scale.CENTER_BOTH,
                width: 1920,
                height: 1080,
            },
            parent: 'game-canvas', // Canvas se incrustará en este div
            backgroundColor: '#000000',
            physics: {
                default: 'arcade',
                arcade: {
                    debug: false,
                },
            },
            scene: [LoginScene,IntroScene, GameScene, ControlScene, PreviewScene, TutorialScene, PauseScene, CreditScene, DialogueScene, EndScene, LoseScene],
        };
        const game = new Phaser.Game(config);
        
        // Variable global para mantener la instancia de chatManager
        window.chatManagerInstance = null;

        $(document).ready(() => {
            const nombre = localStorage.getItem("usuarioNombre");

            // Solo inicializar ChatManager si un usuario ya está logueado al cargar la página.
            // De lo contrario, se inicializará desde LoginScene después de un inicio de sesión exitoso.
            if (nombre && nombre !== "Anónimo") {
                window.chatManagerInstance = new ChatManager();
                $(window).on('beforeunload', () => {
                    if (window.chatManagerInstance) {
                        window.chatManagerInstance.disconnectUser();
                    }
                });
            } else {
                // Deshabilitar los elementos del chat si no hay usuario logueado inicialmente
                $('#chat-input').prop('disabled', true);
                $('#chat-send').prop('disabled', true);
                $('#connection-status').text('No has iniciado sesión. El chat no está disponible.').css({
                    'background-color': '#f44336',
                    'color': 'white'
                });
            }
        });
        
    </script>
    
</body>

</html>